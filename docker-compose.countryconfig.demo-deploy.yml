# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.
#
# OpenCRVS is also distributed under the terms of the Civil Registration
# & Healthcare Disclaimer located at http://opencrvs.org/license.
#
# Copyright (C) The OpenCRVS Authors. OpenCRVS and the OpenCRVS
# graphic logo are (registered/a) trademark(s) of Plan International.
version: '3.3'

services:
  notification:
    environment:
      - LANGUAGES=en,fr
      - SENTRY_DSN=https://f892d643aab642108f44e2d1795706bc@o309867.ingest.sentry.io/1774604

  countryconfig:
    image: ${DOCKERHUB_ACCOUNT}/${DOCKERHUB_REPO}:${COUNTRY_CONFIG_VERSION:-latest}
    restart: unless-stopped
    secrets:
      - jwt-public-key.{{ts}}
    environment:
      - NODE_ENV=production
      - FHIR_URL=http://hearth:3447/fhir
      - AUTH_URL=http://auth:4040
      - OPENHIM_URL=http://openhim-core:5001/fhir
      - CONFIRM_REGISTRATION_URL=http://openhim-core:5001/confirm/registration
      - CHECK_INVALID_TOKEN=true
      - HOSTNAME=${HOSTNAME}
      - SENTRY_DSN=https://f892d643aab642108f44e2d1795706bc@o309867.ingest.sentry.io/1774604

    deploy:
      replicas: 1
    networks:
      - overlay_net

  client:
    environment:
      - DECLARED_DECLARATION_SEARCH_QUERY_COUNT = 100

  gateway:
    environment:
      - LANGUAGES=en,fr
      - SENTRY_DSN=https://f892d643aab642108f44e2d1795706bc@o309867.ingest.sentry.io/1774604
      - NATIONAL_ID_OIDP_BASE_URL=https://esignet-mock.collab.mosip.net/
      - NATIONAL_ID_OIDP_CLIENT_PRIVATE_KEY=ewogICAgInAiOiAieDFqWHFEYmUtajljWVcyZ3RhRFgyVG9rZ2pDM1FHRGR6RkxrenNOOExKa3QzdDVIZVp6T0Fld3RnN3NHdExHTTJ0M29HWURyeXRwOEJGa0plV09aQWUtbmg2dHlJUE1icjJ1eWp1WDlLLUdVbHkxcU1TRUZRS3FWbFU2RFJudHhwX2NOVmFOSVhISTJiYUxOUGJyRVl4UVFHX3NVbkVlbENwM1lKVzlDNGpVIiwKICAgICJrdHkiOiAiUlNBIiwKICAgICJxIjogInZjcXJMbEhBRHFnQzVKUTZpNThMMGQyUVN2bVY2RVhDWXNYMWxsZXoxcTFXUVluMFlxR3NJZk5Ub3o3QjU5ekZTWmltOEtRQ1NRN25XVVU2RjE2b1V5V1Exa3I1LW9EeUF0Vmp6WXk4VnMtakNHaTl0WjVTX2JoMzhPeHpjQzV4ZmhkejdTYmY2QTVocUJ1dzVJQjZGTmVSQmdqcUxiS0JTRDNyMlhYV3VQTSIsCiAgICAiZCI6ICJMbXFJdHR4TXRiVXhBQTJ3VWVZdjBhUGZ2eW41NHc2eUZZNnZTMGQ1aUdtX0dUTWd5ZXBtZ2R2Y3BHbkhQdUJLdmlKcm5xbk5nb29OTGtXVU9OWDN3eU9DczhjLXR2S20xM2ZfWVBZa3R2SHZDSTVRNW1NMkdjbUktYWozR1RFcFBYR0g5em1VMVczWFNnUEVoVkNtTXB4eDJOeVB6SUtlazJ2VkpKc2w5S2FsbEszYTFYSEVUM21qVV9XZTU5VTJLdW96U3ZoMkxkMzFyaXRVQjFJZG9zdnVrQmNfY0xkRldUcTlyazZnbUFhRUdvbGQweE1JcE5LVHJYZEJ2QXRibVUwN0RqUkRPMzQtbzB5YlBzZ0FkTExKaFkwTmV1YkVaSzZiZ1otSWtIYUlCUFlJbFpnak11aFRxcExjWWFjZlFrWnZjLWVFZzU0MUVSUTlWeW5qR1EiLAogICAgImUiOiAiQVFBQiIsCiAgICAicWkiOiAicVNGdHFGVmx5d3FkdEY0RVBHUVJrQlVfMWdDWmRMcWxGX0NpUE5HbTVVNlZuU0YtSzRwcThTaHJrOHhjRHlfYzUxbnFvNGJ3WW9tQmZxLXJEbnFKWTRQQURIRjZ4ZnZEaHZNUDlVT3hMVGJjbzNhZDc0ejExdGs5bEozNllVX3FIQWxkaHo1VTY5MXR2RUVQTzFacER5R2V0MGhubTR6SWJrUWRUMWdMR0pBIiwKICAgICJkcCI6ICJyZWl0eTB5RFhtSGtZQUxaejFwUXRHdnE2Y0ZDUFdIRVhicDdibjVRV0VBU0tucFVkSjM5Z3VQZUdTd1NmNVRkd3hzUW54OF9sYXJod3BGQ21LbnhGQ1ZWVENDZjRtcjBYaWRna1JYSHRuNkh1Uk9mcnRpVjBvSl9HTkJ6Nmd0TGJqTXphT0NZQWo2SmlVQWNPWncwTkJPT3NqcHJFcVBXTWRyZWRGb0tTWGsiLAogICAgImRxIjogImdNWXBuZFVFSGkyclFOSy1Zb3U0cGwzU0VMMEdGTUo0WVRKMkx0czBfNTAtNEZzdFFWcjNBMVlwVXFNN1NBb0lwcVgzNTJFdzE4ZFAtOGMzNGpGc3ZuWEhyMDdTREVFX2MtSzd3X1VRdVVwTEVXS1lEY250XzQ4UmVwdkV1OElYYVhtYVE3ZlR4bzB6ZjZfQ04xaGdfUkZDcWppVVJBdFJJdVk0eDZUbjJ6YyIsCiAgICAibiI6ICJrOHBvbmNUcXNkcXlTenJ5R2l5NHVBVktiUmtNdGlRb1RPdzRfT21pbC1icmh2eUhvWVBheWxaRnVrNUc3UzBuMTZyWnBObm5fXzZhZ0lOZTF6aFB6X3QtNF9QeEdqS2toaWtuVTZMS0tfeWtRVW5iOXd2aVF4VkQzSFA1NkZqaUpTdzFNU0o5WWMzV0ZZRkxQMklqU2N5amxfUVJlYnNDc3czNWFlSTA5TWhNV25jVUhYNFZ2Z1JhYjkxMFlyUUZQYVVpQU5ISC1vcjhKSGhFRkpYR2hIWXdUWER6TU5Fel9GeEpXbm5uLU9sQ1VFdG94aHJwU1doeVJ3Q0JWeElIUHI4bjl1LXAzeHZLSU9QTUYyeW1hS3d6eTU2QldDZC1HTjBMcGxNRG9HTGpJd294Q1d4U25vXzduSjZoMkpXQkxjZkktdXBpWXlmV1RReTVBR0RRVHciCn0=
  workflow:
    environment:
      - LANGUAGES=en,fr
      - MOSIP_TOKEN_SEEDER_URL=http://mosiptokenseeder:8080
      - SENTRY_DSN=https://f892d643aab642108f44e2d1795706bc@o309867.ingest.sentry.io/1774604

  auth:
    environment:
      - QA_ENV=true
      - NODE_ENV=production
      - SENTRY_DSN=https://f892d643aab642108f44e2d1795706bc@o309867.ingest.sentry.io/1774604

  user-mgnt:
    environment:
      - QA_ENV=true
      - NODE_ENV=production
      - SENTRY_DSN=https://f892d643aab642108f44e2d1795706bc@o309867.ingest.sentry.io/1774604
      - NATIONAL_ID_OIDP_BASE_URL=https://esignet-mock.collab.mosip.net/
      - NATIONAL_ID_OIDP_CLIENT_ID=3yz7-j3xRzU3SODdoNgSGvO_cD8UijH3AIWRDAg1x-M
      - NATIONAL_ID_OIDP_ESSENTIAL_CLAIMS=name,address,birthdate
  
  config:
    environment:
      - SENTRY_DSN=https://f892d643aab642108f44e2d1795706bc@o309867.ingest.sentry.io/1774604

  metrics:
    environment:
      - SENTRY_DSN=https://f892d643aab642108f44e2d1795706bc@o309867.ingest.sentry.io/1774604

  search:
    environment:
      - SENTRY_DSN=https://f892d643aab642108f44e2d1795706bc@o309867.ingest.sentry.io/1774604

  webhooks:
    environment:
      - SENTRY_DSN=https://f892d643aab642108f44e2d1795706bc@o309867.ingest.sentry.io/1774604
  
  mosiptokenseeder:
    image: mosipdev/mosip-token-seeder:develop
    ports:
      - '8085:8080'
    deploy:
      replicas: 1
    networks:
      - overlay_net
    volumes:
      - /data/secrets/mosip:/seeder/certs
    restart: unless-stopped
    environment:
      - TOKENSEEDER_MOSIP_AUTH__PARTNER_APIKEY=${TOKENSEEDER_MOSIP_AUTH__PARTNER_APIKEY}
      - TOKENSEEDER_MOSIP_AUTH__PARTNER_MISP_LK=${TOKENSEEDER_MOSIP_AUTH__PARTNER_MISP_LK}
      - TOKENSEEDER_MOSIP_AUTH__PARTNER_ID=opencrvs-auth-partner
      - TOKENSEEDER_MOSIP_AUTH_SERVER__IDA_AUTH_DOMAIN_URI=https://api-internal.mec.mosip.net
      - TOKENSEEDER_MOSIP_AUTH_SERVER__IDA_AUTH_URL=https://api.mec.mosip.net/idauthentication/v1/auth
      - TOKENSEEDER_CRYPTO_SIGNATURE__SIGN_P12_FILE_PASSWORD=${TOKENSEEDER_CRYPTO_SIGNATURE__SIGN_P12_FILE_PASSWORD}
      - TOKENSEEDER_AUTHTOKEN__MANDATORY_VALIDATION_AUTH_FIELDS="name,gender,dob"
      - TOKENSEEDER_CRYPTO_ENCRYPT__ENCRYPT_CERT_PATH=/seeder/certs/ida.partner.crt
      - TOKENSEEDER_CRYPTO_SIGNATURE__SIGN_P12_FILE_PATH=/seeder/certs/keystore.p12
      - TOKENSEEDER_ROOT__SYNC_OPERATION_MODE=true

secrets:
  openhim-user:
    external: true
  openhim-password:
    external: true
